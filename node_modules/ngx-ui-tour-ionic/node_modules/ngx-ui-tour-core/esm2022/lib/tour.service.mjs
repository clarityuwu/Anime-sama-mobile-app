import { inject, Injectable } from '@angular/core';
import { NavigationStart, Router } from '@angular/router';
import { delay, filter, first, map, merge as mergeStatic, Subject, takeUntil } from 'rxjs';
import { ScrollingService } from './scrolling.service';
import { TourBackdropService } from './tour-backdrop.service';
import { AnchorClickService } from './anchor-click.service';
import { ScrollBlockingService } from './scroll-blocking.service';
import { deepMerge } from './deep-merge';
import * as i0 from "@angular/core";
export var TourState;
(function (TourState) {
    TourState[TourState["OFF"] = 0] = "OFF";
    TourState[TourState["ON"] = 1] = "ON";
    TourState[TourState["PAUSED"] = 2] = "PAUSED";
})(TourState || (TourState = {}));
export var Direction;
(function (Direction) {
    Direction[Direction["Forwards"] = 0] = "Forwards";
    Direction[Direction["Backwards"] = 1] = "Backwards";
})(Direction || (Direction = {}));
const DEFAULT_STEP_OPTIONS = {
    disableScrollToAnchor: false,
    prevBtnTitle: 'Prev',
    nextBtnTitle: 'Next',
    endBtnTitle: 'End',
    enableBackdrop: false,
    isAsync: false,
    isOptional: false,
    delayAfterNavigation: 100,
    delayBeforeStepShow: 0,
    nextOnAnchorClick: false,
    duplicateAnchorHandling: 'error',
    centerAnchorOnScroll: true,
    disablePageScrolling: true,
    smoothScroll: true,
    allowUserInitiatedNavigation: false,
    stepDimensions: {
        minWidth: '250px',
        maxWidth: '280px',
        width: 'auto'
    }
};
// noinspection JSUnusedGlobalSymbols
export class TourService {
    constructor() {
        this.stepShow$ = new Subject();
        this.stepHide$ = new Subject();
        this.initialize$ = new Subject();
        this.start$ = new Subject();
        this.end$ = new Subject();
        this.pause$ = new Subject();
        this.resume$ = new Subject();
        this.anchorRegister$ = new Subject();
        this.anchorUnregister$ = new Subject();
        this.events$ = mergeStatic(this.stepShow$.pipe(map(value => ({ name: 'stepShow', value }))), this.stepHide$.pipe(map(value => ({ name: 'stepHide', value }))), this.initialize$.pipe(map(value => ({ name: 'initialize', value }))), this.start$.pipe(map(value => ({ name: 'start', value }))), this.end$.pipe(map(value => ({ name: 'end', value }))), this.pause$.pipe(map(value => ({ name: 'pause', value }))), this.resume$.pipe(map(value => ({ name: 'resume', value }))), this.anchorRegister$.pipe(map(value => ({
            name: 'anchorRegister',
            value
        }))), this.anchorUnregister$.pipe(map(value => ({
            name: 'anchorUnregister',
            value
        }))));
        this.steps = [];
        this.anchors = {};
        this.status = TourState.OFF;
        this.isHotKeysEnabled = true;
        this.direction = Direction.Forwards;
        this.waitingForScroll = false;
        this.navigationStarted = false;
        this.router = inject(Router);
        this.backdrop = inject(TourBackdropService);
        this.anchorClickService = inject(AnchorClickService);
        this.scrollBlockingService = inject(ScrollBlockingService);
        this.scrollingService = inject(ScrollingService);
    }
    initialize(steps, stepDefaults) {
        if (this.status === TourState.ON) {
            console.warn('Can not re-initialize the UI tour while it\'s still active');
            return;
        }
        if (steps && steps.length > 0) {
            this.status = TourState.OFF;
            this.steps = steps.map(step => deepMerge(DEFAULT_STEP_OPTIONS, this.userDefaults, stepDefaults, step));
            this.validateSteps();
            this.initialize$.next(this.steps);
            this.subscribeToNavigationStartEvent();
        }
    }
    setDefaults(defaultOptions) {
        this.userDefaults = defaultOptions;
    }
    getDefaults() {
        return this.userDefaults;
    }
    validateSteps() {
        for (const step of this.steps) {
            if (step.isAsync && step.isOptional) {
                throw new Error(`Tour step with anchor id "${step.anchorId}" can not be both "async" and "optional"!`);
            }
        }
    }
    subscribeToNavigationStartEvent() {
        this.router.events
            .pipe(filter((event) => event instanceof NavigationStart), takeUntil(this.end$))
            .subscribe((event) => {
            const browserBackBtnPressed = event.navigationTrigger === 'popstate', userNavigationAllowed = this.currentStep?.allowUserInitiatedNavigation;
            if (!this.navigationStarted && (browserBackBtnPressed || !userNavigationAllowed)) {
                this.end();
            }
        });
    }
    disableHotkeys() {
        this.isHotKeysEnabled = false;
    }
    enableHotkeys() {
        this.isHotKeysEnabled = true;
    }
    start() {
        if (this.status === TourState.ON) {
            console.warn('tourService.start() called while the tour is already running.');
            return;
        }
        this.startAt(0);
    }
    startAt(stepId) {
        this.status = TourState.ON;
        this.goToStep(this.loadStep(stepId));
        this.start$.next();
    }
    end() {
        if (this.waitingForScroll) {
            return;
        }
        if (this.status === TourState.OFF) {
            return;
        }
        this.status = TourState.OFF;
        this.disableTour();
        this.currentStep = undefined;
        this.end$.next();
    }
    pause() {
        this.status = TourState.PAUSED;
        this.disableTour();
        this.pause$.next();
    }
    disableTour() {
        this.hideStep(this.currentStep);
        this.anchorClickService.removeListener();
        this.backdrop.close();
        this.backdrop.disconnectResizeObserver();
        this.scrollBlockingService.disable();
    }
    resume() {
        this.status = TourState.ON;
        this.showStep(this.currentStep);
        this.resume$.next();
    }
    toggle(pause) {
        if (pause) {
            if (this.currentStep) {
                this.pause();
            }
            else {
                this.resume();
            }
        }
        else {
            if (this.currentStep) {
                this.end();
            }
            else {
                this.start();
            }
        }
    }
    next() {
        if (this.waitingForScroll) {
            return;
        }
        this.direction = Direction.Forwards;
        if (this.hasNext(this.currentStep)) {
            this.goToStep(this.loadStep(this.currentStep.nextStep ?? this.getStepIndex(this.currentStep) + 1));
        }
    }
    getStepIndex(step) {
        const index = this.steps.indexOf(step);
        return index < 0 ? 0 : index;
    }
    hasNext(step) {
        if (!step) {
            console.warn('Can\'t get next step. No currentStep.');
            return false;
        }
        return (step.nextStep !== undefined ||
            (this.getStepIndex(step) < this.steps.length - 1 && !this.isNextOptionalAnchorMissing(step)));
    }
    isNextOptionalAnchorMissing(step) {
        const stepIndex = this.getStepIndex(step);
        for (let i = stepIndex + 1; i < this.steps.length; i++) {
            const nextStep = this.steps[i];
            if (!nextStep.isOptional || this.anchors[nextStep.anchorId])
                return false;
        }
        return true;
    }
    prev() {
        if (this.waitingForScroll) {
            return;
        }
        this.direction = Direction.Backwards;
        if (this.hasPrev(this.currentStep)) {
            this.goToStep(this.loadStep(this.currentStep.prevStep ?? this.getStepIndex(this.currentStep) - 1));
        }
    }
    hasPrev(step) {
        if (!step) {
            console.warn('Can\'t get previous step. No currentStep.');
            return false;
        }
        return step.prevStep !== undefined ||
            (this.getStepIndex(step) > 0 && !this.isPrevOptionalAnchorMising(step));
    }
    isPrevOptionalAnchorMising(step) {
        const stepIndex = this.getStepIndex(step);
        for (let i = stepIndex - 1; i > -1; i--) {
            const prevStep = this.steps[i];
            if (!prevStep.isOptional || this.anchors[prevStep.anchorId])
                return false;
        }
        return true;
    }
    goto(stepId) {
        this.goToStep(this.loadStep(stepId));
    }
    register(anchorId, anchor) {
        if (!anchorId) {
            return;
        }
        if (this.anchors[anchorId]) {
            const step = this.findStepByAnchorId(anchorId), duplicateAnchorHandling = step?.duplicateAnchorHandling ??
                this.userDefaults?.duplicateAnchorHandling ?? 'error';
            switch (duplicateAnchorHandling) {
                case 'error':
                    throw new Error(`Tour anchor with id "${anchorId}" already registered!`);
                case 'registerFirst':
                    return;
            }
        }
        this.anchors[anchorId] = anchor;
        this.anchorRegister$.next(anchorId);
    }
    findStepByAnchorId(anchorId) {
        return this.steps.find(step => step.anchorId === anchorId);
    }
    unregister(anchorId) {
        if (!anchorId) {
            return;
        }
        delete this.anchors[anchorId];
        this.anchorUnregister$.next(anchorId);
    }
    getStatus() {
        return this.status;
    }
    isHotkeysEnabled() {
        return this.isHotKeysEnabled;
    }
    goToStep(step) {
        if (!step) {
            console.warn('Can\'t go to non-existent step');
            this.end();
            return;
        }
        if (this.currentStep) {
            this.backdrop.closeSpotlight();
            this.hideStep(this.currentStep);
        }
        this.anchorClickService.removeListener();
        if (step.route !== undefined && step.route !== null) {
            this.navigateToRouteAndSetStep(step);
        }
        else {
            this.setCurrentStepAsync(step);
        }
    }
    listenToOnAnchorClick(step) {
        if (step.nextOnAnchorClick) {
            const anchorEl = this.anchors[step.anchorId].element.nativeElement;
            this.anchorClickService.addListener(anchorEl, () => this.next());
        }
    }
    async navigateToRouteAndSetStep(step) {
        const url = typeof step.route === 'string' ? step.route : this.router.createUrlTree(step.route), matchOptions = {
            paths: 'exact',
            matrixParams: 'exact',
            queryParams: 'subset',
            fragment: 'exact'
        };
        const isActive = this.router.isActive(url, matchOptions);
        if (isActive) {
            this.setCurrentStepAsync(step);
            return;
        }
        this.navigationStarted = true;
        const navigated = await this.router.navigateByUrl(url);
        this.navigationStarted = false;
        if (!navigated) {
            console.warn('Navigation to route failed: ', step.route);
            this.end();
        }
        else {
            this.setCurrentStepAsync(step, step.delayAfterNavigation);
        }
    }
    loadStep(stepId) {
        if (typeof stepId === 'number') {
            return this.steps[stepId];
        }
        else {
            return this.steps.find(step => step.stepId === stepId);
        }
    }
    setCurrentStep(step) {
        this.currentStep = step;
        this.showStep(this.currentStep);
    }
    setCurrentStepAsync(step, delay = 0) {
        delay = delay || step.delayBeforeStepShow;
        setTimeout(() => this.setCurrentStep(step), delay);
    }
    async showStep(step) {
        const anchor = this.anchors[step && step.anchorId];
        if (!anchor) {
            if (step.isAsync) {
                this.anchorRegister$
                    .pipe(filter(anchorId => anchorId === step.anchorId), first(), delay(0))
                    .subscribe(() => this.showStep(step));
                return;
            }
            if (step.isOptional) {
                this.direction === Direction.Forwards ? this.next() : this.prev();
                return;
            }
            console.warn('Can\'t attach to unregistered anchor with id ' + step.anchorId);
            this.end();
            return;
        }
        this.listenToOnAnchorClick(step);
        this.waitingForScroll = true;
        await this.scrollToAnchor(step);
        this.waitingForScroll = false;
        anchor.showTourStep(step);
        this.toggleBackdrop(step);
        this.togglePageScrolling(step);
        this.stepShow$.next({
            step,
            direction: this.direction
        });
    }
    hideStep(step) {
        const anchor = this.anchors[step && step.anchorId];
        if (!anchor) {
            return;
        }
        anchor.hideTourStep();
        this.stepHide$.next({
            step,
            direction: this.direction
        });
    }
    scrollToAnchor(step) {
        if (step.disableScrollToAnchor) {
            return Promise.resolve();
        }
        const anchor = this.anchors[step?.anchorId], htmlElement = anchor.element.nativeElement;
        return this.scrollingService.ensureVisible(htmlElement, {
            center: step.centerAnchorOnScroll,
            smoothScroll: step.smoothScroll,
            scrollContainer: step.scrollContainer
        });
    }
    toggleBackdrop(step) {
        const anchor = this.anchors[step?.anchorId];
        if (step.enableBackdrop) {
            this.backdrop.show(anchor.element, step);
        }
        else {
            this.backdrop.close();
        }
    }
    togglePageScrolling(step) {
        if (step.disablePageScrolling) {
            this.scrollBlockingService.enable(step.scrollContainer);
        }
        else {
            this.scrollBlockingService.disable();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: TourService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: TourService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: TourService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG91ci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXVpLXRvdXItY29yZS9zcmMvbGliL3RvdXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUVqRCxPQUFPLEVBQXVCLGVBQWUsRUFBRSxNQUFNLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUc5RSxPQUFPLEVBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssSUFBSSxXQUFXLEVBQWMsT0FBTyxFQUFFLFNBQVMsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNyRyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQWlCLG1CQUFtQixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDNUUsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDMUQsT0FBTyxFQUFDLHFCQUFxQixFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFDaEUsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLGNBQWMsQ0FBQzs7QUEwQ3ZDLE1BQU0sQ0FBTixJQUFZLFNBSVg7QUFKRCxXQUFZLFNBQVM7SUFDakIsdUNBQUcsQ0FBQTtJQUNILHFDQUFFLENBQUE7SUFDRiw2Q0FBTSxDQUFBO0FBQ1YsQ0FBQyxFQUpXLFNBQVMsS0FBVCxTQUFTLFFBSXBCO0FBRUQsTUFBTSxDQUFOLElBQVksU0FHWDtBQUhELFdBQVksU0FBUztJQUNqQixpREFBUSxDQUFBO0lBQ1IsbURBQVMsQ0FBQTtBQUNiLENBQUMsRUFIVyxTQUFTLEtBQVQsU0FBUyxRQUdwQjtBQU9ELE1BQU0sb0JBQW9CLEdBQWdCO0lBQ3RDLHFCQUFxQixFQUFFLEtBQUs7SUFDNUIsWUFBWSxFQUFFLE1BQU07SUFDcEIs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dGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgdHlwZSB7VXJsU2VnbWVudH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHtJc0FjdGl2ZU1hdGNoT3B0aW9ucywgTmF2aWdhdGlvblN0YXJ0LCBSb3V0ZXJ9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcblxyXG5pbXBvcnQge1RvdXJBbmNob3JEaXJlY3RpdmV9IGZyb20gJy4vdG91ci1hbmNob3IuZGlyZWN0aXZlJztcclxuaW1wb3J0IHtkZWxheSwgZmlsdGVyLCBmaXJzdCwgbWFwLCBtZXJnZSBhcyBtZXJnZVN0YXRpYywgT2JzZXJ2YWJsZSwgU3ViamVjdCwgdGFrZVVudGlsfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtTY3JvbGxpbmdTZXJ2aWNlfSBmcm9tICcuL3Njcm9sbGluZy5zZXJ2aWNlJztcclxuaW1wb3J0IHtCYWNrZHJvcENvbmZpZywgVG91ckJhY2tkcm9wU2VydmljZX0gZnJvbSAnLi90b3VyLWJhY2tkcm9wLnNlcnZpY2UnO1xyXG5pbXBvcnQge0FuY2hvckNsaWNrU2VydmljZX0gZnJvbSAnLi9hbmNob3ItY2xpY2suc2VydmljZSc7XHJcbmltcG9ydCB7U2Nyb2xsQmxvY2tpbmdTZXJ2aWNlfSBmcm9tICcuL3Njcm9sbC1ibG9ja2luZy5zZXJ2aWNlJztcclxuaW1wb3J0IHtkZWVwTWVyZ2V9IGZyb20gJy4vZGVlcC1tZXJnZSc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFN0ZXBEaW1lbnNpb25zIHtcclxuICAgIHdpZHRoPzogc3RyaW5nO1xyXG4gICAgbWluV2lkdGg/OiBzdHJpbmc7XHJcbiAgICBtYXhXaWR0aD86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJU3RlcE9wdGlvbiB7XHJcbiAgICBzdGVwSWQ/OiBzdHJpbmc7XHJcbiAgICBhbmNob3JJZD86IHN0cmluZztcclxuICAgIHRpdGxlPzogc3RyaW5nO1xyXG4gICAgY29udGVudD86IHN0cmluZztcclxuICAgIHJvdXRlPzogc3RyaW5nIHwgVXJsU2VnbWVudFtdO1xyXG4gICAgbmV4dFN0ZXA/OiBudW1iZXIgfCBzdHJpbmc7XHJcbiAgICBwcmV2U3RlcD86IG51bWJlciB8IHN0cmluZztcclxuICAgIGRpc2FibGVTY3JvbGxUb0FuY2hvcj86IGJvb2xlYW47XHJcbiAgICBjZW50ZXJBbmNob3JPblNjcm9sbD86IGJvb2xlYW47XHJcbiAgICBzbW9vdGhTY3JvbGw/OiBib29sZWFuO1xyXG4gICAgLyoqXHJcbiAgICAgKiBDU1Mgc2VsZWN0b3Igb3IgaHRtbCBlbGVtZW50IHJlZmVyZW5jZS4gT25seSBzZXQgdGhpcyBjb25maWcgaWYgeW91IGhhdmUgZW5hYmxlZCBcInNtb290aFNjcm9sbFwiIGFuZCB0b3VyIHN0ZXBcclxuICAgICAqIGRlc2NyaXB0aW9uIHBvcHMtdXAgYmVmb3JlIHNjcm9sbGluZyBoYXMgZmluaXNoZWQgb3IgZG9lc24ndCBzaG93IHVwIGF0IGFsbC4gVGhpcyBzaG91bGQgb25seSBiZSB0aGUgY2FzZSB3aGVuXHJcbiAgICAgKiBzY3JvbGwgY29udGFpbmVyIGlzIHBhcnQgb2Ygc2hhZG93IERPTS5cclxuICAgICAqL1xyXG4gICAgc2Nyb2xsQ29udGFpbmVyPzogc3RyaW5nIHwgSFRNTEVsZW1lbnQ7XHJcbiAgICBwcmV2QnRuVGl0bGU/OiBzdHJpbmc7XHJcbiAgICBuZXh0QnRuVGl0bGU/OiBzdHJpbmc7XHJcbiAgICBlbmRCdG5UaXRsZT86IHN0cmluZztcclxuICAgIGVuYWJsZUJhY2tkcm9wPzogYm9vbGVhbjtcclxuICAgIGJhY2tkcm9wQ29uZmlnPzogQmFja2Ryb3BDb25maWc7XHJcbiAgICBpc0FzeW5jPzogYm9vbGVhbjtcclxuICAgIGlzT3B0aW9uYWw/OiBib29sZWFuO1xyXG4gICAgZGVsYXlBZnRlck5hdmlnYXRpb24/OiBudW1iZXI7XHJcbiAgICBkZWxheUJlZm9yZVN0ZXBTaG93PzogbnVtYmVyO1xyXG4gICAgbmV4dE9uQW5jaG9yQ2xpY2s/OiBib29sZWFuO1xyXG4gICAgZHVwbGljYXRlQW5jaG9ySGFuZGxpbmc/OiAnZXJyb3InIHwgJ3JlZ2lzdGVyRmlyc3QnIHwgJ3JlZ2lzdGVyTGFzdCc7XHJcbiAgICBkaXNhYmxlUGFnZVNjcm9sbGluZz86IGJvb2xlYW47XHJcbiAgICBhbGxvd1VzZXJJbml0aWF0ZWROYXZpZ2F0aW9uPzogYm9vbGVhbjtcclxuICAgIHN0ZXBEaW1lbnNpb25zPzogU3RlcERpbWVuc2lvbnM7XHJcbiAgICBwb3BvdmVyQ2xhc3M/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBlbnVtIFRvdXJTdGF0ZSB7XHJcbiAgICBPRkYsXHJcbiAgICBPTixcclxuICAgIFBBVVNFRFxyXG59XHJcblxyXG5leHBvcnQgZW51bSBEaXJlY3Rpb24ge1xyXG4gICAgRm9yd2FyZHMsXHJcbiAgICBCYWNrd2FyZHNcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTdGVwQ2hhbmdlUGFyYW1zPFQgZXh0ZW5kcyBJU3RlcE9wdGlvbiA9IElTdGVwT3B0aW9uPiB7XHJcbiAgICBzdGVwOiBUO1xyXG4gICAgZGlyZWN0aW9uOiBEaXJlY3Rpb247XHJcbn1cclxuXHJcbmNvbnN0IERFRkFVTFRfU1RFUF9PUFRJT05TOiBJU3RlcE9wdGlvbiA9IHtcclxuICAgIGRpc2FibGVTY3JvbGxUb0FuY2hvcjogZmFsc2UsXHJcbiAgICBwcmV2QnRuVGl0bGU6ICdQcmV2JyxcclxuICAgIG5leHRCdG5UaXRsZTogJ05leHQnLFxyXG4gICAgZW5kQnRuVGl0bGU6ICdFbmQnLFxyXG4gICAgZW5hYmxlQmFja2Ryb3A6IGZhbHNlLFxyXG4gICAgaXNBc3luYzogZmFsc2UsXHJcbiAgICBpc09wdGlvbmFsOiBmYWxzZSxcclxuICAgIGRlbGF5QWZ0ZXJOYXZpZ2F0aW9uOiAxMDAsXHJcbiAgICBkZWxheUJlZm9yZVN0ZXBTaG93OiAwLFxyXG4gICAgbmV4dE9uQW5jaG9yQ2xpY2s6IGZhbHNlLFxyXG4gICAgZHVwbGljYXRlQW5jaG9ySGFuZGxpbmc6ICdlcnJvcicsXHJcbiAgICBjZW50ZXJBbmNob3JPblNjcm9sbDogdHJ1ZSxcclxuICAgIGRpc2FibGVQYWdlU2Nyb2xsaW5nOiB0cnVlLFxyXG4gICAgc21vb3RoU2Nyb2xsOiB0cnVlLFxyXG4gICAgYWxsb3dVc2VySW5pdGlhdGVkTmF2aWdhdGlvbjogZmFsc2UsXHJcbiAgICBzdGVwRGltZW5zaW9uczoge1xyXG4gICAgICAgIG1pbldpZHRoOiAnMjUwcHgnLFxyXG4gICAgICAgIG1heFdpZHRoOiAnMjgwcHgnLFxyXG4gICAgICAgIHdpZHRoOiAnYXV0bydcclxuICAgIH1cclxufTtcclxuXHJcbi8vIG5vaW5zcGVjdGlvbiBKU1VudXNlZEdsb2JhbFN5bWJvbHNcclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUb3VyU2VydmljZTxUIGV4dGVuZHMgSVN0ZXBPcHRpb24gPSBJU3RlcE9wdGlvbj4ge1xyXG5cclxuICAgIHB1YmxpYyBzdGVwU2hvdyQ6IFN1YmplY3Q8U3RlcENoYW5nZVBhcmFtczxUPj4gPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgcHVibGljIHN0ZXBIaWRlJDogU3ViamVjdDxTdGVwQ2hhbmdlUGFyYW1zPFQ+PiA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBwdWJsaWMgaW5pdGlhbGl6ZSQ6IFN1YmplY3Q8VFtdPiA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBwdWJsaWMgc3RhcnQkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcclxuICAgIHB1YmxpYyBlbmQkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcclxuICAgIHB1YmxpYyBwYXVzZSQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgcHVibGljIHJlc3VtZSQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgcHVibGljIGFuY2hvclJlZ2lzdGVyJDogU3ViamVjdDxzdHJpbmc+ID0gbmV3IFN1YmplY3QoKTtcclxuICAgIHB1YmxpYyBhbmNob3JVbnJlZ2lzdGVyJDogU3ViamVjdDxzdHJpbmc+ID0gbmV3IFN1YmplY3QoKTtcclxuICAgIHB1YmxpYyBldmVudHMkOiBPYnNlcnZhYmxlPHsgbmFtZTogc3RyaW5nOyB2YWx1ZTogdW5rbm93biB9PiA9IG1lcmdlU3RhdGljKFxyXG4gICAgICAgIHRoaXMuc3RlcFNob3ckLnBpcGUobWFwKHZhbHVlID0+ICh7bmFtZTogJ3N0ZXBTaG93JywgdmFsdWV9KSkpLFxyXG4gICAgICAgIHRoaXMuc3RlcEhpZGUkLnBpcGUobWFwKHZhbHVlID0+ICh7bmFtZTogJ3N0ZXBIaWRlJywgdmFsdWV9KSkpLFxyXG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZSQucGlwZShtYXAodmFsdWUgPT4gKHtuYW1lOiAnaW5pdGlhbGl6ZScsIHZhbHVlfSkpKSxcclxuICAgICAgICB0aGlzLnN0YXJ0JC5waXBlKG1hcCh2YWx1ZSA9PiAoe25hbWU6ICdzdGFydCcsIHZhbHVlfSkpKSxcclxuICAgICAgICB0aGlzLmVuZCQucGlwZShtYXAodmFsdWUgPT4gKHtuYW1lOiAnZW5kJywgdmFsdWV9KSkpLFxyXG4gICAgICAgIHRoaXMucGF1c2UkLnBpcGUobWFwKHZhbHVlID0+ICh7bmFtZTogJ3BhdXNlJywgdmFsdWV9KSkpLFxyXG4gICAgICAgIHRoaXMucmVzdW1lJC5waXBlKG1hcCh2YWx1ZSA9PiAoe25hbWU6ICdyZXN1bWUnLCB2YWx1ZX0pKSksXHJcbiAgICAgICAgdGhpcy5hbmNob3JSZWdpc3RlciQucGlwZShcclxuICAgICAgICAgICAgbWFwKHZhbHVlID0+ICh7XHJcbiAgICAgICAgICAgICAgICBuYW1lOiAnYW5jaG9yUmVnaXN0ZXInLFxyXG4gICAgICAgICAgICAgICAgdmFsdWVcclxuICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgKSxcclxuICAgICAgICB0aGlzLmFuY2hvclVucmVnaXN0ZXIkLnBpcGUoXHJcbiAgICAgICAgICAgIG1hcCh2YWx1ZSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgbmFtZTogJ2FuY2hvclVucmVnaXN0ZXInLFxyXG4gICAgICAgICAgICAgICAgdmFsdWVcclxuICAgICAgICAgICAgfSkpXHJcbiAgICAgICAgKVxyXG4gICAgKTtcclxuXHJcbiAgICBwdWJsaWMgc3RlcHM6IFRbXSA9IFtdO1xyXG4gICAgcHVibGljIGN1cnJlbnRTdGVwOiBUO1xyXG5cclxuICAgIHB1YmxpYyBhbmNob3JzOiB7IFthbmNob3JJZDogc3RyaW5nXTogVG91ckFuY2hvckRpcmVjdGl2ZSB9ID0ge307XHJcbiAgICBwcml2YXRlIHN0YXR1czogVG91clN0YXRlID0gVG91clN0YXRlLk9GRjtcclxuICAgIHByaXZhdGUgaXNIb3RLZXlzRW5hYmxlZCA9IHRydWU7XHJcbiAgICBwcml2YXRlIGRpcmVjdGlvbiA9IERpcmVjdGlvbi5Gb3J3YXJkcztcclxuICAgIHByaXZhdGUgd2FpdGluZ0ZvclNjcm9sbCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBuYXZpZ2F0aW9uU3RhcnRlZCA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSB1c2VyRGVmYXVsdHM6IFQ7XHJcblxyXG4gICAgcHJpdmF0ZSByZWFkb25seSByb3V0ZXIgPSBpbmplY3QoUm91dGVyKTtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFja2Ryb3AgPSBpbmplY3QoVG91ckJhY2tkcm9wU2VydmljZSk7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFuY2hvckNsaWNrU2VydmljZSA9IGluamVjdChBbmNob3JDbGlja1NlcnZpY2UpO1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBzY3JvbGxCbG9ja2luZ1NlcnZpY2UgPSBpbmplY3QoU2Nyb2xsQmxvY2tpbmdTZXJ2aWNlKTtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2Nyb2xsaW5nU2VydmljZSA9IGluamVjdChTY3JvbGxpbmdTZXJ2aWNlKTtcclxuXHJcbiAgICBwdWJsaWMgaW5pdGlhbGl6ZShzdGVwczogVFtdLCBzdGVwRGVmYXVsdHM/OiBUKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSBUb3VyU3RhdGUuT04pIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKCdDYW4gbm90IHJlLWluaXRpYWxpemUgdGhlIFVJIHRvdXIgd2hpbGUgaXRcXCdzIHN0aWxsIGFjdGl2ZScpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3RlcHMgJiYgc3RlcHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXR1cyA9IFRvdXJTdGF0ZS5PRkY7XHJcbiAgICAgICAgICAgIHRoaXMuc3RlcHMgPSBzdGVwcy5tYXAoXHJcbiAgICAgICAgICAgICAgICBzdGVwID0+IGRlZXBNZXJnZShcclxuICAgICAgICAgICAgICAgICAgICBERUZBVUxUX1NURVBfT1BUSU9OUyBhcyBULFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXNlckRlZmF1bHRzLFxyXG4gICAgICAgICAgICAgICAgICAgIHN0ZXBEZWZhdWx0cyxcclxuICAgICAgICAgICAgICAgICAgICBzdGVwXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHRoaXMudmFsaWRhdGVTdGVwcygpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRpYWxpemUkLm5leHQodGhpcy5zdGVwcyk7XHJcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaWJlVG9OYXZpZ2F0aW9uU3RhcnRFdmVudCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0RGVmYXVsdHMoZGVmYXVsdE9wdGlvbnM6IFQpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnVzZXJEZWZhdWx0cyA9IGRlZmF1bHRPcHRpb25zO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXREZWZhdWx0cygpOiBUIHtcclxuICAgICAgICByZXR1cm4gdGhpcy51c2VyRGVmYXVsdHM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZVN0ZXBzKCkge1xyXG4gICAgICAgIGZvciAoY29uc3Qgc3RlcCBvZiB0aGlzLnN0ZXBzKSB7XHJcbiAgICAgICAgICAgIGlmIChzdGVwLmlzQXN5bmMgJiYgc3RlcC5pc09wdGlvbmFsKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRvdXIgc3RlcCB3aXRoIGFuY2hvciBpZCBcIiR7c3RlcC5hbmNob3JJZH1cIiBjYW4gbm90IGJlIGJvdGggXCJhc3luY1wiIGFuZCBcIm9wdGlvbmFsXCIhYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzdWJzY3JpYmVUb05hdmlnYXRpb25TdGFydEV2ZW50KClcclxuICAgIHtcclxuICAgICAgICB0aGlzLnJvdXRlci5ldmVudHNcclxuICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXIoKGV2ZW50KTogZXZlbnQgaXMgTmF2aWdhdGlvblN0YXJ0ID0+IGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvblN0YXJ0KSxcclxuICAgICAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLmVuZCQpXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJyb3dzZXJCYWNrQnRuUHJlc3NlZCA9IGV2ZW50Lm5hdmlnYXRpb25UcmlnZ2VyID09PSAncG9wc3RhdGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgdXNlck5hdmlnYXRpb25BbGxvd2VkID0gdGhpcy5jdXJyZW50U3RlcD8uYWxsb3dVc2VySW5pdGlhdGVkTmF2aWdhdGlvbjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLm5hdmlnYXRpb25TdGFydGVkICYmIChicm93c2VyQmFja0J0blByZXNzZWQgfHwgIXVzZXJOYXZpZ2F0aW9uQWxsb3dlZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmQoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGRpc2FibGVIb3RrZXlzKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaXNIb3RLZXlzRW5hYmxlZCA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlbmFibGVIb3RrZXlzKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuaXNIb3RLZXlzRW5hYmxlZCA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXJ0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gVG91clN0YXRlLk9OKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybigndG91clNlcnZpY2Uuc3RhcnQoKSBjYWxsZWQgd2hpbGUgdGhlIHRvdXIgaXMgYWxyZWFkeSBydW5uaW5nLicpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3RhcnRBdCgwKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RhcnRBdChzdGVwSWQ6IG51bWJlciB8IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuc3RhdHVzID0gVG91clN0YXRlLk9OO1xyXG4gICAgICAgIHRoaXMuZ29Ub1N0ZXAodGhpcy5sb2FkU3RlcChzdGVwSWQpKTtcclxuICAgICAgICB0aGlzLnN0YXJ0JC5uZXh0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGVuZCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy53YWl0aW5nRm9yU2Nyb2xsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyA9PT0gVG91clN0YXRlLk9GRikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3RhdHVzID0gVG91clN0YXRlLk9GRjtcclxuICAgICAgICB0aGlzLmRpc2FibGVUb3VyKCk7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50U3RlcCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB0aGlzLmVuZCQubmV4dCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBwYXVzZSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnN0YXR1cyA9IFRvdXJTdGF0ZS5QQVVTRUQ7XHJcbiAgICAgICAgdGhpcy5kaXNhYmxlVG91cigpO1xyXG4gICAgICAgIHRoaXMucGF1c2UkLm5leHQoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRpc2FibGVUb3VyKCkge1xyXG4gICAgICAgIHRoaXMuaGlkZVN0ZXAodGhpcy5jdXJyZW50U3RlcCk7XHJcbiAgICAgICAgdGhpcy5hbmNob3JDbGlja1NlcnZpY2UucmVtb3ZlTGlzdGVuZXIoKTtcclxuICAgICAgICB0aGlzLmJhY2tkcm9wLmNsb3NlKCk7XHJcbiAgICAgICAgdGhpcy5iYWNrZHJvcC5kaXNjb25uZWN0UmVzaXplT2JzZXJ2ZXIoKTtcclxuICAgICAgICB0aGlzLnNjcm9sbEJsb2NraW5nU2VydmljZS5kaXNhYmxlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJlc3VtZSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnN0YXR1cyA9IFRvdXJTdGF0ZS5PTjtcclxuICAgICAgICB0aGlzLnNob3dTdGVwKHRoaXMuY3VycmVudFN0ZXApO1xyXG4gICAgICAgIHRoaXMucmVzdW1lJC5uZXh0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRvZ2dsZShwYXVzZT86IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgICAgICBpZiAocGF1c2UpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGF1c2UoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzdW1lKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50U3RlcCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmQoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbmV4dCgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy53YWl0aW5nRm9yU2Nyb2xsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuZGlyZWN0aW9uID0gRGlyZWN0aW9uLkZvcndhcmRzO1xyXG4gICAgICAgIGlmICh0aGlzLmhhc05leHQodGhpcy5jdXJyZW50U3RlcCkpIHtcclxuICAgICAgICAgICAgdGhpcy5nb1RvU3RlcChcclxuICAgICAgICAgICAgICAgIHRoaXMubG9hZFN0ZXAoXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3RlcC5uZXh0U3RlcCA/PyB0aGlzLmdldFN0ZXBJbmRleCh0aGlzLmN1cnJlbnRTdGVwKSArIDFcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRTdGVwSW5kZXgoc3RlcDogVCk6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnN0ZXBzLmluZGV4T2Yoc3RlcCk7XHJcblxyXG4gICAgICAgIHJldHVybiBpbmRleCA8IDAgPyAwIDogaW5kZXg7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGhhc05leHQoc3RlcDogVCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghc3RlcCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ0NhblxcJ3QgZ2V0IG5leHQgc3RlcC4gTm8gY3VycmVudFN0ZXAuJyk7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgc3RlcC5uZXh0U3RlcCAhPT0gdW5kZWZpbmVkIHx8XHJcbiAgICAgICAgICAgICh0aGlzLmdldFN0ZXBJbmRleChzdGVwKSA8IHRoaXMuc3RlcHMubGVuZ3RoIC0gMSAmJiAhdGhpcy5pc05leHRPcHRpb25hbEFuY2hvck1pc3Npbmcoc3RlcCkpXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzTmV4dE9wdGlvbmFsQW5jaG9yTWlzc2luZyhzdGVwOiBUKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3Qgc3RlcEluZGV4ID0gdGhpcy5nZXRTdGVwSW5kZXgoc3RlcCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSBzdGVwSW5kZXggKyAxOyBpIDwgdGhpcy5zdGVwcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBuZXh0U3RlcCA9IHRoaXMuc3RlcHNbaV07XHJcblxyXG4gICAgICAgICAgICBpZiAoIW5leHRTdGVwLmlzT3B0aW9uYWwgfHwgdGhpcy5hbmNob3JzW25leHRTdGVwLmFuY2hvcklkXSlcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBwcmV2KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLndhaXRpbmdGb3JTY3JvbGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5kaXJlY3Rpb24gPSBEaXJlY3Rpb24uQmFja3dhcmRzO1xyXG4gICAgICAgIGlmICh0aGlzLmhhc1ByZXYodGhpcy5jdXJyZW50U3RlcCkpIHtcclxuICAgICAgICAgICAgdGhpcy5nb1RvU3RlcChcclxuICAgICAgICAgICAgICAgIHRoaXMubG9hZFN0ZXAoXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3RlcC5wcmV2U3RlcCA/PyB0aGlzLmdldFN0ZXBJbmRleCh0aGlzLmN1cnJlbnRTdGVwKSAtIDFcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGhhc1ByZXYoc3RlcDogVCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghc3RlcCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ0NhblxcJ3QgZ2V0IHByZXZpb3VzIHN0ZXAuIE5vIGN1cnJlbnRTdGVwLicpO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzdGVwLnByZXZTdGVwICE9PSB1bmRlZmluZWQgfHxcclxuICAgICAgICAgICAgKHRoaXMuZ2V0U3RlcEluZGV4KHN0ZXApID4gMCAmJiAhdGhpcy5pc1ByZXZPcHRpb25hbEFuY2hvck1pc2luZyhzdGVwKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc1ByZXZPcHRpb25hbEFuY2hvck1pc2luZyhzdGVwOiBUKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3Qgc3RlcEluZGV4ID0gdGhpcy5nZXRTdGVwSW5kZXgoc3RlcCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSBzdGVwSW5kZXggLSAxOyBpID4gLTE7IGktLSkge1xyXG4gICAgICAgICAgICBjb25zdCBwcmV2U3RlcCA9IHRoaXMuc3RlcHNbaV07XHJcblxyXG4gICAgICAgICAgICBpZiAoIXByZXZTdGVwLmlzT3B0aW9uYWwgfHwgdGhpcy5hbmNob3JzW3ByZXZTdGVwLmFuY2hvcklkXSlcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnb3RvKHN0ZXBJZDogbnVtYmVyIHwgc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5nb1RvU3RlcCh0aGlzLmxvYWRTdGVwKHN0ZXBJZCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZWdpc3RlcihhbmNob3JJZDogc3RyaW5nLCBhbmNob3I6IFRvdXJBbmNob3JEaXJlY3RpdmUpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIWFuY2hvcklkKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmFuY2hvcnNbYW5jaG9ySWRdKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0ZXAgPSB0aGlzLmZpbmRTdGVwQnlBbmNob3JJZChhbmNob3JJZCksXHJcbiAgICAgICAgICAgICAgICBkdXBsaWNhdGVBbmNob3JIYW5kbGluZyA9IHN0ZXA/LmR1cGxpY2F0ZUFuY2hvckhhbmRsaW5nID8/XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51c2VyRGVmYXVsdHM/LmR1cGxpY2F0ZUFuY2hvckhhbmRsaW5nID8/ICdlcnJvcic7XHJcblxyXG4gICAgICAgICAgICBzd2l0Y2ggKGR1cGxpY2F0ZUFuY2hvckhhbmRsaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdlcnJvcic6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUb3VyIGFuY2hvciB3aXRoIGlkIFwiJHthbmNob3JJZH1cIiBhbHJlYWR5IHJlZ2lzdGVyZWQhYCk7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdyZWdpc3RlckZpcnN0JzpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuYW5jaG9yc1thbmNob3JJZF0gPSBhbmNob3I7XHJcbiAgICAgICAgdGhpcy5hbmNob3JSZWdpc3RlciQubmV4dChhbmNob3JJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBmaW5kU3RlcEJ5QW5jaG9ySWQoYW5jaG9ySWQ6IHN0cmluZyk6IFQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0ZXBzLmZpbmQoc3RlcCA9PiBzdGVwLmFuY2hvcklkID09PSBhbmNob3JJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVucmVnaXN0ZXIoYW5jaG9ySWQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmICghYW5jaG9ySWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkZWxldGUgdGhpcy5hbmNob3JzW2FuY2hvcklkXTtcclxuICAgICAgICB0aGlzLmFuY2hvclVucmVnaXN0ZXIkLm5leHQoYW5jaG9ySWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRTdGF0dXMoKTogVG91clN0YXRlIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdGF0dXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGlzSG90a2V5c0VuYWJsZWQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaXNIb3RLZXlzRW5hYmxlZDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdvVG9TdGVwKHN0ZXA6IFQpOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXN0ZXApIHtcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKCdDYW5cXCd0IGdvIHRvIG5vbi1leGlzdGVudCBzdGVwJyk7XHJcbiAgICAgICAgICAgIHRoaXMuZW5kKCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXApIHtcclxuICAgICAgICAgICAgdGhpcy5iYWNrZHJvcC5jbG9zZVNwb3RsaWdodCgpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZGVTdGVwKHRoaXMuY3VycmVudFN0ZXApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5hbmNob3JDbGlja1NlcnZpY2UucmVtb3ZlTGlzdGVuZXIoKTtcclxuXHJcbiAgICAgICAgaWYgKHN0ZXAucm91dGUgIT09IHVuZGVmaW5lZCAmJiBzdGVwLnJvdXRlICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMubmF2aWdhdGVUb1JvdXRlQW5kU2V0U3RlcChzdGVwKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRTdGVwQXN5bmMoc3RlcCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbGlzdGVuVG9PbkFuY2hvckNsaWNrKHN0ZXA6IFQpIHtcclxuICAgICAgICBpZiAoc3RlcC5uZXh0T25BbmNob3JDbGljaykge1xyXG4gICAgICAgICAgICBjb25zdCBhbmNob3JFbCA9IHRoaXMuYW5jaG9yc1tzdGVwLmFuY2hvcklkXS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIHRoaXMuYW5jaG9yQ2xpY2tTZXJ2aWNlLmFkZExpc3RlbmVyKGFuY2hvckVsLCAoKSA9PiB0aGlzLm5leHQoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgbmF2aWdhdGVUb1JvdXRlQW5kU2V0U3RlcChzdGVwOiBUKSB7XHJcbiAgICAgICAgY29uc3QgdXJsID0gdHlwZW9mIHN0ZXAucm91dGUgPT09ICdzdHJpbmcnID8gc3RlcC5yb3V0ZSA6IHRoaXMucm91dGVyLmNyZWF0ZVVybFRyZWUoc3RlcC5yb3V0ZSksXHJcbiAgICAgICAgICAgIG1hdGNoT3B0aW9uczogSXNBY3RpdmVNYXRjaE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICBwYXRoczogJ2V4YWN0JyxcclxuICAgICAgICAgICAgICAgIG1hdHJpeFBhcmFtczogJ2V4YWN0JyxcclxuICAgICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zOiAnc3Vic2V0JyxcclxuICAgICAgICAgICAgICAgIGZyYWdtZW50OiAnZXhhY3QnXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0IGlzQWN0aXZlID0gdGhpcy5yb3V0ZXIuaXNBY3RpdmUodXJsLCBtYXRjaE9wdGlvbnMpO1xyXG5cclxuICAgICAgICBpZiAoaXNBY3RpdmUpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRDdXJyZW50U3RlcEFzeW5jKHN0ZXApO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLm5hdmlnYXRpb25TdGFydGVkID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCBuYXZpZ2F0ZWQgPSBhd2FpdCB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVybCk7XHJcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uU3RhcnRlZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICBpZiAoIW5hdmlnYXRlZCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ05hdmlnYXRpb24gdG8gcm91dGUgZmFpbGVkOiAnLCBzdGVwLnJvdXRlKTtcclxuICAgICAgICAgICAgdGhpcy5lbmQoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRTdGVwQXN5bmMoc3RlcCwgc3RlcC5kZWxheUFmdGVyTmF2aWdhdGlvbik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbG9hZFN0ZXAoc3RlcElkOiBudW1iZXIgfCBzdHJpbmcpOiBUIHtcclxuICAgICAgICBpZiAodHlwZW9mIHN0ZXBJZCA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RlcHNbc3RlcElkXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdGVwcy5maW5kKHN0ZXAgPT4gc3RlcC5zdGVwSWQgPT09IHN0ZXBJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0Q3VycmVudFN0ZXAoc3RlcDogVCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuY3VycmVudFN0ZXAgPSBzdGVwO1xyXG4gICAgICAgIHRoaXMuc2hvd1N0ZXAodGhpcy5jdXJyZW50U3RlcCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRDdXJyZW50U3RlcEFzeW5jKHN0ZXA6IFQsIGRlbGF5ID0gMCk6IHZvaWQge1xyXG4gICAgICAgIGRlbGF5ID0gZGVsYXkgfHwgc3RlcC5kZWxheUJlZm9yZVN0ZXBTaG93O1xyXG5cclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuc2V0Q3VycmVudFN0ZXAoc3RlcCksIGRlbGF5KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgYXN5bmMgc2hvd1N0ZXAoc3RlcDogVCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIGNvbnN0IGFuY2hvciA9IHRoaXMuYW5jaG9yc1tzdGVwICYmIHN0ZXAuYW5jaG9ySWRdO1xyXG5cclxuICAgICAgICBpZiAoIWFuY2hvcikge1xyXG4gICAgICAgICAgICBpZiAoc3RlcC5pc0FzeW5jKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFuY2hvclJlZ2lzdGVyJFxyXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoYW5jaG9ySWQgPT4gYW5jaG9ySWQgPT09IHN0ZXAuYW5jaG9ySWQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxheSgwKVxyXG4gICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoKSA9PiB0aGlzLnNob3dTdGVwKHN0ZXApXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoc3RlcC5pc09wdGlvbmFsKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLkZvcndhcmRzID8gdGhpcy5uZXh0KCkgOiB0aGlzLnByZXYoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc29sZS53YXJuKFxyXG4gICAgICAgICAgICAgICAgJ0NhblxcJ3QgYXR0YWNoIHRvIHVucmVnaXN0ZXJlZCBhbmNob3Igd2l0aCBpZCAnICsgc3RlcC5hbmNob3JJZFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLmVuZCgpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubGlzdGVuVG9PbkFuY2hvckNsaWNrKHN0ZXApO1xyXG4gICAgICAgIHRoaXMud2FpdGluZ0ZvclNjcm9sbCA9IHRydWU7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5zY3JvbGxUb0FuY2hvcihzdGVwKTtcclxuICAgICAgICB0aGlzLndhaXRpbmdGb3JTY3JvbGwgPSBmYWxzZTtcclxuICAgICAgICBhbmNob3Iuc2hvd1RvdXJTdGVwKHN0ZXApO1xyXG4gICAgICAgIHRoaXMudG9nZ2xlQmFja2Ryb3Aoc3RlcCk7XHJcbiAgICAgICAgdGhpcy50b2dnbGVQYWdlU2Nyb2xsaW5nKHN0ZXApO1xyXG4gICAgICAgIHRoaXMuc3RlcFNob3ckLm5leHQoe1xyXG4gICAgICAgICAgICBzdGVwLFxyXG4gICAgICAgICAgICBkaXJlY3Rpb246IHRoaXMuZGlyZWN0aW9uXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoaWRlU3RlcChzdGVwOiBUKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgYW5jaG9yID0gdGhpcy5hbmNob3JzW3N0ZXAgJiYgc3RlcC5hbmNob3JJZF07XHJcbiAgICAgICAgaWYgKCFhbmNob3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhbmNob3IuaGlkZVRvdXJTdGVwKCk7XHJcbiAgICAgICAgdGhpcy5zdGVwSGlkZSQubmV4dCh7XHJcbiAgICAgICAgICAgIHN0ZXAsXHJcbiAgICAgICAgICAgIGRpcmVjdGlvbjogdGhpcy5kaXJlY3Rpb25cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNjcm9sbFRvQW5jaG9yKHN0ZXA6IFQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBpZiAoc3RlcC5kaXNhYmxlU2Nyb2xsVG9BbmNob3IpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgYW5jaG9yID0gdGhpcy5hbmNob3JzW3N0ZXA/LmFuY2hvcklkXSxcclxuICAgICAgICAgICAgaHRtbEVsZW1lbnQgPSBhbmNob3IuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxpbmdTZXJ2aWNlLmVuc3VyZVZpc2libGUoaHRtbEVsZW1lbnQsIHtcclxuICAgICAgICAgICAgY2VudGVyOiBzdGVwLmNlbnRlckFuY2hvck9uU2Nyb2xsLFxyXG4gICAgICAgICAgICBzbW9vdGhTY3JvbGw6IHN0ZXAuc21vb3RoU2Nyb2xsLFxyXG4gICAgICAgICAgICBzY3JvbGxDb250YWluZXI6IHN0ZXAuc2Nyb2xsQ29udGFpbmVyXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB0b2dnbGVCYWNrZHJvcChzdGVwOiBUKSB7XHJcbiAgICAgICAgY29uc3QgYW5jaG9yID0gdGhpcy5hbmNob3JzW3N0ZXA/LmFuY2hvcklkXTtcclxuXHJcbiAgICAgICAgaWYgKHN0ZXAuZW5hYmxlQmFja2Ryb3ApIHtcclxuICAgICAgICAgICAgdGhpcy5iYWNrZHJvcC5zaG93KGFuY2hvci5lbGVtZW50LCBzdGVwKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmJhY2tkcm9wLmNsb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdG9nZ2xlUGFnZVNjcm9sbGluZyhzdGVwOiBUKSB7XHJcbiAgICAgICAgaWYgKHN0ZXAuZGlzYWJsZVBhZ2VTY3JvbGxpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5zY3JvbGxCbG9ja2luZ1NlcnZpY2UuZW5hYmxlKHN0ZXAuc2Nyb2xsQ29udGFpbmVyKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNjcm9sbEJsb2NraW5nU2VydmljZS5kaXNhYmxlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=